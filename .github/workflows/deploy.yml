name: üöÄ Deploy to Server

on:
  push:
    branches:
      - main
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SERVER_KEY }}

      - name: Deploy to Server
        run: |
          # Determine environment name from branch
          ENV=${GITHUB_REF_NAME}

          # Docker image path
          IMAGE="ghcr.io/${{ github.repository_owner }}/jhs-timesnap:$ENV"

          # Docker container name
          APP_NAME="jhs_timesnap_$ENV"

          # Choose correct port for staging/production
          if [ "$ENV" = "main" ]; then
            PORT=8011
            MONGO="${{ secrets.MONGO_CONNECTION_STRING_PRODUCTION }}"
            SMTP="${{ secrets.SMTP_KEY_PRODUCTION }}"
            JWT="${{ secrets.JWT_SECRET_PRODUCTION }}"
          else
            PORT=8010
            MONGO="${{ secrets.MONGO_CONNECTION_STRING_STAGING }}"
            SMTP="${{ secrets.SMTP_KEY_STAGING }}"
            JWT="${{ secrets.JWT_SECRET_STAGING }}"
          fi

          echo "üåç Environment: $ENV"
          echo "üê≥ Image: $IMAGE"
          echo "üîå Using port: $PORT"
          echo "üì¶ Container: $APP_NAME"

          ssh -p ${{ secrets.SERVER_PORT }} -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
              
              echo '‚è¨ Logging into GHCR...'
              echo '${{ secrets.GHCR_PAT }}' | docker login ghcr.io -u '${{ github.actor }}' --password-stdin

              echo 'üì• Pulling latest image...'
              docker pull $IMAGE

              echo 'üõë Stopping old container if exists...'
              docker stop $APP_NAME || true
              docker rm $APP_NAME || true

              echo '‚ñ∂Ô∏è Starting new container on port $PORT...'
              docker run -d \
                --name $APP_NAME \
                -p $PORT:8000 \
                -e APP_ENV=$ENV \
                -e MONGO_CONNECTION_STRING=\"$MONGO\" \
                -e SMTP_KEY=\"$SMTP\" \
                -e JWT_SECRET=\"$JWT\" \
                $IMAGE

              echo 'üßπ Cleaning Docker garbage...'
              docker system prune -af --volumes

              echo '‚úÖ Deployment completed for $ENV!'
          "
